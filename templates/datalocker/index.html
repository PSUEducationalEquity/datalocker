{# Copyright 2015 The Pennsylvania State University. Office of the Vice Provost for Educational Equity. All Rights Reserved. #}
{% extends "datalocker/app_template.html" %}
{% load staticfiles %}
{% load datalocker_tags %}

{% block breadcrumb-trail %}
  <li class="active">
    <span class="sr-only">List of </span>My Lockers
  </li>
{% endblock breadcrumb-trail %}

{% block page-meta-title %}My Lockers{% endblock page-meta-title %}

{% block site-styles %}
  {{ block.super }}
  <link type="text/css" rel="stylesheet"
        href="{% static 'datalocker/css/bootstrap-toggle.css' %}" />
{% endblock site-styles %}

{% block content %}
    <h1 class="hidden">Data lockers</h1>
    <ul class="messages list-unstyled" id="user-messages">
      {% for msg in messages %}
        <li class="alert {{ msg.tags }}">{{ msg|safe }}</li>
      {% endfor %}
    </ul>
    <div class="container-fluid">
      <div class="hide-show-archived-lockers-checkbox">
      <input type="checkbox"
        id="hide-show-archived-lockers"
        class="hide-show-archived-lockers-checkbox"
        name="onoffswitch"
        data-size="small"
        data-toggle="toggle"
        data-onstyle="success"
        data-offstyle="danger"
        data-on="Hide Archived Lockers"
        data-off="Show Archived Lockers">
      </div>
      <h2 class="italic">My Lockers</h2>
      {% if owned|length > 0 %}
        <table class="table table-striped table-hover listing tablesorter"
               data-archive-url="{% url 'datalocker:archive_locker' 0 %}"
               data-unarchive-url="{% url 'datalocker:unarchive_locker' 0 %}"
               id="locker-list">
          <caption>List of Lockers that I own</caption>
          <thead>
            <tr>
              <th>Form Name</th>
              <th class="hidden-xs">Latest Submission</th>
              <th><span class="sr-only">Locker Actions</span></th>
            </tr>
          </thead>
          <tbody>
            {% for locker in owned %}
              <tr data-id="{{ locker.id }}" data-name="{{ locker.name }}"
                  data-settings="{{ locker.get_settings|jsonify }}"
              {% if locker.archive_timestamp != None %} class="is-archived" {% endif %}>
                <td class="record-name">
                  <a href="{% url 'datalocker:submissions_list' locker.pk %}">{{ locker.name }}</a>
                  <span class="label label-default archived-label">Archived</span>
                </td>
                <td class="hidden-xs">{{ locker.latest_submission }}</td>
                <td class="record-actions">
                  <button type="button" class="btn btn-primary btn-xs" role="edit-users" title="Edit users for this locker">Share</button>
                  <button type="button" class="btn btn-info btn-xs" role="edit-locker" title="Edit this locker">Edit</button>
                  <button type="button"
                          class="btn btn-success btn-xs"
                          role="unarchive-locker"
                          >Unarchive</button>
                  <button type="button"
                          class="btn btn-danger btn-xs"
                          role="archive-locker"
                          >Archive</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>You currently do not own any Lockers.
        You can add lockers of your own by adding a forms from Plone Form Gen.
        </p>
      {% endif %}
      <hr />
      {% if shared|length > 0 %}
        <h2 class="italic">Lockers Shared with Me</h2>
        <table class="table table-striped table-hover listing tablesorter"
          id="shared-locker-list">
          <caption>List of Lockers that have been shared with me</caption>
          <thead>
            <tr>
              <th>Form Name</th>
              <th class="hidden-xs">Latest Submission</th>
            </tr>
          </thead>
          <tbody>
            {% for locker in shared %}
              <tr data-id="{{ locker.id }}"
              {% if locker.archive_timestamp != None %} class="is-archived" {% endif %}>
                <td class="record-name">
                  <a href="{% url 'datalocker:submissions_list' locker.pk %}">{{ locker.name }}
                  </a>
                  {% if locker.archive_timestamp != null %}
                    <span class="label label-default">Archived</span>
                  {% endif %}
                </td>
                <td class="hidden-xs">{{ locker.latest_submission }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
{% endblock %}


{% block dialogs %}
{% comment %}
  Modal used for Editing the Locker.
  The name and the owner of the existing
  Locker is what is changed here
{% endcomment %}
  <div class="modal fade" id="dialog-edit-users" tabindex="-1"
    role="dialog" aria-labelledby="dialog-edit-users-title"
    aria-hidden="true" data-locker-id="0">
      <div class="modal-dialog">
        <div id="not-a-user-alert"
          class="alert alert-danger">This User Does Not Exist
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        <div class="modal-content">
          <form method="POST" name="modalForm"  action=""
            data-url="{% url 'datalocker:locker_user_add' 0 %}">
            {% csrf_token %}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title" id="dialog-edit-users-title">Share access to this locker</h4>
          </div>
          <div class="modal-body">
            <div>
              <h5 clss="modal-title"><strong>Users who have access to this locker</strong></h5>
              <ul id="existing-users"
                data-delete-url="{% url 'datalocker:locker_user_delete' 0 %}"
                data-url="{% url 'datalocker:locker_users' 0 %}">
              </ul>
              <h5 class="modal-title share-access-title"
                id="dialog-edit-access-users-title">
                <strong>Share access to this locker with someone else</strong>
              </h5>
              <label for="email"><span class="sr-only">Email Address</span></label>
              <input type="text"
                name="email"
                class="typeahead"
                id="email"
                style="width:200px;"
                placeholder="Enter the email address to share this locker with">
              <button type="submit" class="btn btn-primary btn-sm add-btn" id="button-user-add">
                Add</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-sm pull-left"
              data-dismiss="modal" />Done</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{% comment %}
  Modal used for Edit the users of the Locker.
  You can add or remove users from the existing
  locker by adding or removing existing email addresses
{% endcomment %}
  <div class="modal fade" id="dialog-edit-locker" tabindex="-1" role="dialog"
    aria-labelledby="dialog-edit-locker-title" aria-hidden="true"
    data-locker-id="0">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" name="modalLocker"
            data-url="{% url 'datalocker:modify_locker' 0 %}">
            {% csrf_token %}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title" id="dialog-edit-locker-title">Edit Locker</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
             <label for="edit-locker">Name</label>
               <input type="text"
                  name="edit-locker"
                  class="form-control"
                  id="edit-locker"
                  value="">
               <br/>
            </div>
            <div class="form-group">
              <label for="edit-owner">Owner</label>
                <input type="text"
                  name="edit-owner"
                  class="form-control"
                  id="edit-owner"
                  placeholder="Enter a new owner's email address">
               <br/>
            </div>
            <input type="checkbox"
                name="shared-users"
                id="shared-users"
                class="always"
                value="True"
              >
              <label for="shared-users">
                Email users that have access to this locker
              </label>
            <div>
              <input type="checkbox"
                name="enable-workflow"
                id="enable-workflow"
                class="always"
                value="True"
                data-target="workflow"/
              >
              <label for="enable-workflow">
                Enable Workflow
              </label>
            </div>
            <div id="locker-options">
              <input type="checkbox"
                name="users-can-edit-workflow"
                class="always"
                value="True"
                id="users-can-edit-state">
                Users can edit the workflow
                <br/>
              <textarea cols="20" rows="3"
                name="workflow-states-textarea" id="workflow-states-textarea"> </textarea>   Workflow states <br/>
            </div>
            <input type="checkbox"
              name="enable-discussion"
              class="always"
              value="True"
              id="enable-discussion">
            <label for="enable-discussion">
            Enable discussion
            </label>
            <div id="discussion-options">
              <input type="checkbox"
                name="users-can-view-discussion"
                class="always"
                value="True"
                id="users-can-view-discussion">
              Users have access to discussion<br/>
            </div>
          </div>
          <div class="modal-footer">
            <input type="submit" class="btn btn-primary btn-sm pull-left" value="Save" />
            <button type="button" class="btn btn-default btn-sm pull-left"
              data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{% endblock dialogs%}

{% block site-scripts %}
    {{ block.super }}
    <script type="text/javascript"
            src=" {% static 'datalocker/js/bootstrap-toggle.js' %}"></script>
    <script type="text/javascript"
            src=" {% static 'datalocker/js/tablesorter.js' %}"></script>
    <script type="text/javascript"
            src=" {% static 'datalocker/js/locker.js' %}"></script>
    <script type="text/javascript"
            src=" {% static 'datalocker/js/workflow.js' %}"></script>
    <script type="text/javascript"
            src=" {% static 'datalocker/js/typeahead.js' %}"></script>
    <script>
    $(document).ready(function($) {
        // Workaround for bug in mouse item selection
       $('input.typeahead').typeahead({
        name: 'users',
        prefetch: {user:'user'}
        limit: 10
    });
    </script>
{% endblock site-scripts %}
